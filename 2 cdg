<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lectorium - Biblioteca Digital I.E. Luis Carlos López</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
    
    :root {
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --success: #48bb78;
      --warning: #f6ad55;
      --danger: #fc8181;
      --info: #4299e1;
      --dark: #2d3748;
      --light: #f7fafc;
      
      /* Typography Scale */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;
      --text-4xl: 2.25rem;
    }
    
    /* Modo Oscuro */
    [data-theme="dark"] {
      --bg-primary: #1a202c;
      --bg-secondary: #2d3748;
      --bg-tertiary: #4a5568;
      --text-primary: #f7fafc;
      --text-secondary: #cbd5e0;
      --border-color: #4a5568;
    }
    
    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f7fafc;
      --bg-tertiary: #edf2f7;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --border-color: #e2e8f0;
    }
    
    * {
      scroll-behavior: smooth;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: var(--text-base);
      line-height: 1.5;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Headings */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      line-height: 1.25;
      color: var(--text-primary);
    }
    
    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Micro-interactions */
    .micro-interaction {
      transition: all 0.2s ease;
    }
    
    .micro-interaction:hover {
      transform: scale(1.05);
    }
    
    .micro-interaction:active {
      transform: scale(0.95);
    }
    
    /* Cards */
    .stat-card {
      background: var(--bg-primary);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    
    /* Book Cards */
    .book-card {
      transition: all 0.3s ease;
    }
    
    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    /* Tabs */
    .tab-active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary);
    }
    
    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: -300px;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1000;
      max-width: 350px;
    }
    
    .toast.show {
      right: 20px;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
    
    /* Focus visible */
    *:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .stat-card {
        padding: 1rem;
      }
      
      h1 { font-size: var(--text-2xl); }
      h2 { font-size: var(--text-xl); }
      h3 { font-size: var(--text-lg); }
    }
  </style>
</head>
<body>
  <!-- Theme Toggle -->
  <button id="themeToggle" class="fixed top-4 right-4 z-50 bg-white dark:bg-gray-800 p-3 rounded-full shadow-lg micro-interaction">
    <i id="themeIcon" class="fas fa-moon text-gray-800 dark:text-yellow-300"></i>
  </button>
  
  <!-- Main Header -->
  <header class="glass sticky top-0 z-40 px-6 py-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-3 rounded-xl">
          <i class="fas fa-book-open text-white text-2xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold tracking-tight">Lectorium</h1>
          <p class="text-sm opacity-80 font-medium">Biblioteca Digital - I.E. Luis Carlos López</p>
        </div>
      </div>
      
      <nav class="flex items-center space-x-6">
        <!-- Notification Bell -->
        <button id="notificationBtn" class="relative micro-interaction">
          <i class="fas fa-bell text-xl"></i>
          <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
        </button>
        
        <!-- User Menu -->
        <div class="relative">
          <button id="loginBtn" class="glass px-4 py-2 rounded-lg font-semibold micro-interaction uppercase tracking-wide text-sm">
            <i class="fas fa-sign-in-alt mr-2"></i>
            Iniciar Sesión
          </button>
          
          <div id="userMenu" class="hidden">
            <button id="userMenuBtn" class="flex items-center space-x-2 glass px-4 py-2 rounded-lg">
              <i class="fas fa-user-circle text-2xl text-purple-600"></i>
              <span id="userEmail" class="text-sm font-medium"></span>
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            
            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-64 glass rounded-xl shadow-xl p-2">
              <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <p class="font-semibold" id="dropdownName">Usuario</p>
                <p class="text-xs opacity-70" id="dropdownEmail">email@ieluiscarloslopez.edu.co</p>
              </div>
              
              <button id="profileBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg micro-interaction font-medium text-sm">
                <i class="fas fa-user-circle mr-2"></i> Mi Perfil
              </button>
              <button id="historyBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg micro-interaction font-medium text-sm">
                <i class="fas fa-history mr-2"></i> Historial
              </button>
              <hr class="my-2 border-gray-200 dark:border-gray-700">
              <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-red-50 dark:hover:bg-red-900 text-red-600 rounded-lg micro-interaction font-medium text-sm">
                <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
              </button>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>
  
  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- Dashboard Tabs -->
    <div class="glass rounded-xl p-1 mb-8">
      <div class="flex space-x-1 overflow-x-auto">
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction tab-active text-sm uppercase tracking-wider whitespace-nowrap" data-tab="dashboard">
          <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
        </button>
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction text-sm uppercase tracking-wider whitespace-nowrap" data-tab="catalog">
          <i class="fas fa-books mr-2"></i> Catálogo
        </button>
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction text-sm uppercase tracking-wider whitespace-nowrap" data-tab="loans">
          <i class="fas fa-book-reader mr-2"></i> Préstamos
        </button>
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction text-sm uppercase tracking-wider whitespace-nowrap" data-tab="repository">
          <i class="fas fa-archive mr-2"></i> Repositorio
        </button>
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction text-sm uppercase tracking-wider whitespace-nowrap" data-tab="resources">
          <i class="fas fa-database mr-2"></i> Recursos
        </button>
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction text-sm uppercase tracking-wider whitespace-nowrap" data-tab="multimedia">
          <i class="fas fa-video mr-2"></i> Multimedia
        </button>
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction text-sm uppercase tracking-wider whitespace-nowrap" data-tab="training">
          <i class="fas fa-graduation-cap mr-2"></i> Formación
        </button>
        <button class="tab-btn flex-1 px-4 py-3 rounded-lg font-medium micro-interaction text-sm uppercase tracking-wider whitespace-nowrap" data-tab="analytics">
          <i class="fas fa-chart-bar mr-2"></i> Estadísticas
        </button>
      </div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content animate-fade-in">
      <!-- Welcome Section -->
      <div class="glass rounded-xl p-8 mb-8">
        <h2 class="text-3xl font-bold mb-2 tracking-tight">Bienvenido a Lectorium</h2>
        <p class="text-lg opacity-80 leading-relaxed">Sistema de gestión bibliotecaria digital para la I.E. Luis Carlos López</p>
      </div>
      
      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="stat-card">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-sm font-medium opacity-70 uppercase tracking-wider mb-1">Total Libros</p>
              <p class="text-3xl font-bold" id="totalBooksCount">0</p>
            </div>
            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
              <i class="fas fa-book text-blue-600 dark:text-blue-400"></i>
            </div>
          </div>
          <p class="text-sm opacity-70">En el catálogo</p>
        </div>
        
        <div class="stat-card">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-sm font-medium opacity-70 uppercase tracking-wider mb-1">Disponibles</p>
              <p class="text-3xl font-bold" id="availableBooksCount">0</p>
            </div>
            <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg">
              <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
            </div>
          </div>
          <p class="text-sm opacity-70">Para préstamo</p>
        </div>
        
        <div class="stat-card">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-sm font-medium opacity-70 uppercase tracking-wider mb-1">Mis Préstamos</p>
              <p class="text-3xl font-bold" id="myLoansCount">0</p>
            </div>
            <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-lg">
              <i class="fas fa-book-reader text-purple-600 dark:text-purple-400"></i>
            </div>
          </div>
          <p class="text-sm opacity-70">Activos</p>
        </div>
        
        <div class="stat-card">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-sm font-medium opacity-70 uppercase tracking-wider mb-1">Vencimientos</p>
              <p class="text-3xl font-bold" id="dueSoonCount">0</p>
            </div>
            <div class="bg-orange-100 dark:bg-orange-900 p-3 rounded-lg">
              <i class="fas fa-clock text-orange-600 dark:text-orange-400"></i>
            </div>
          </div>
          <p class="text-sm opacity-70">Esta semana</p>
        </div>
      </div>
      
      <!-- Recent Activity & Quick Actions -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Recent Books -->
        <div class="glass rounded-xl p-6">
          <h3 class="text-xl font-bold mb-4 tracking-tight">Libros Recientes</h3>
          <div id="recentBooks" class="space-y-3">
            <!-- Will be populated dynamically -->
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="glass rounded-xl p-6">
          <h3 class="text-xl font-bold mb-4 tracking-tight">Acciones Rápidas</h3>
          <div class="space-y-3">
            <button onclick="document.querySelector('[data-tab=\'catalog\']').click()" class="w-full glass p-4 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <div class="flex items-center space-x-3">
                <i class="fas fa-search text-purple-600 text-xl"></i>
                <div>
                  <p class="font-semibold">Buscar Libros</p>
                  <p class="text-sm opacity-70">Explora nuestro catálogo completo</p>
                </div>
              </div>
            </button>
            
            <button onclick="document.querySelector('[data-tab=\'loans\']').click()" class="w-full glass p-4 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <div class="flex items-center space-x-3">
                <i class="fas fa-book-reader text-blue-600 text-xl"></i>
                <div>
                  <p class="font-semibold">Ver Mis Préstamos</p>
                  <p class="text-sm opacity-70">Gestiona tus libros prestados</p>
                </div>
              </div>
            </button>
            
            <button onclick="showNotification('Función en desarrollo', 'info')" class="w-full glass p-4 rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <div class="flex items-center space-x-3">
                <i class="fas fa-qrcode text-green-600 text-xl"></i>
                <div>
                  <p class="font-semibold">Escanear ISBN</p>
                  <p class="text-sm opacity-70">Busca libros por código de barras</p>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Catalog Tab -->
    <div id="catalog-tab" class="tab-content hidden">
      <!-- Search and Filters -->
      <div class="glass rounded-xl p-6 mb-8">
        <div class="flex items-center space-x-4">
          <div class="flex-1 relative">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 opacity-50"></i>
            <input 
              type="text" 
              id="searchInput" 
              class="w-full pl-12 pr-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium"
              placeholder="Buscar por título, autor o ISBN..."
            >
          </div>
          <select id="categoryFilter" class="px-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium">
            <option value="">Todas las categorías</option>
            <option value="clasico">Clásicos</option>
            <option value="moderno">Modernos</option>
            <option value="ficcion">Ficción</option>
            <option value="ciencia">Ciencia</option>
            <option value="historia">Historia</option>
            <option value="infantil">Infantil</option>
            <option value="juvenil">Juvenil</option>
          </select>
          <button id="searchBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold micro-interaction">
            <i class="fas fa-search mr-2"></i> Buscar
          </button>
        </div>
        
        <!-- Active Filters -->
        <div id="activeFilters" class="mt-4 flex flex-wrap gap-2 hidden"></div>
      </div>
      
      <!-- Books Grid -->
      <div id="loadingBooks" class="flex justify-center py-12 hidden">
        <div class="spinner"></div>
      </div>
      
      <div id="booksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
      
      <div id="noResults" class="text-center py-16 hidden">
        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
        <p class="text-gray-500 text-lg">No se encontraron libros con esos criterios</p>
      </div>
    </div>
    
    <!-- Loans Tab -->
    <div id="loans-tab" class="tab-content hidden">
      <div class="glass rounded-xl p-6">
        <h2 class="text-2xl font-bold mb-6 tracking-tight">Mis Préstamos Activos</h2>
        <div id="loansContainer" class="space-y-4">
          <!-- Loans will be loaded here -->
        </div>
      </div>
    </div>
    
    <!-- Analytics Tab -->
    <div id="analytics-tab" class="tab-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Monthly Stats -->
        <div class="glass rounded-xl p-6">
          <h3 class="text-xl font-bold mb-4 tracking-tight">Préstamos Mensuales</h3>
          <canvas id="monthlyChart" width="400" height="200"></canvas>
        </div>
        
        <!-- Category Distribution -->
        <div class="glass rounded-xl p-6">
          <h3 class="text-xl font-bold mb-4 tracking-tight">Distribución por Categorías</h3>
          <canvas id="categoryChart" width="400" height="200"></canvas>
        </div>
      </div>
      
      <!-- Most Borrowed Books -->
      <div class="glass rounded-xl p-6 mt-6">
        <h3 class="text-xl font-bold mb-4 tracking-tight">Libros Más Solicitados</h3>
        <div id="topBooks" class="space-y-3">
          <!-- Will be populated -->
        </div>
      </div>
    </div>
    
    <!-- Repository Tab -->
    <div id="repository-tab" class="tab-content hidden">
      <div class="glass rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4 tracking-tight">Repositorio Institucional</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Accede a trabajos de grado, proyectos de investigación y publicaciones de nuestra institución.</p>
        
        <!-- Repository Search -->
        <div class="flex items-center space-x-4 mb-6">
          <div class="flex-1 relative">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 opacity-50"></i>
            <input 
              type="text" 
              id="repositorySearch" 
              class="w-full pl-12 pr-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium"
              placeholder="Buscar en el repositorio..."
            >
          </div>
          <select id="repositoryType" class="px-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg font-medium">
            <option value="">Todos los tipos</option>
            <option value="tesis">Trabajos de Grado</option>
            <option value="investigacion">Investigaciones</option>
            <option value="articulo">Artículos</option>
            <option value="proyecto">Proyectos</option>
          </select>
        </div>
        
        <!-- Repository Items -->
        <div id="repositoryItems" class="space-y-4">
          <div class="glass rounded-lg p-4 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold text-lg">Exploradores digitales: el rol de los juegos educativos</h4>
                <p class="text-sm opacity-70">Caicedo Suárez E., Cardosis Julio C. - 2025</p>
                <p class="text-sm mt-2">Fortalecimiento de la producción oral y escrita en estudiantes de tercer grado mediante juegos educativos digitales.</p>
                <div class="flex items-center space-x-4 mt-3 text-sm">
                  <span class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">Tesis</span>
                  <span><i class="fas fa-download mr-1"></i> 145 descargas</span>
                </div>
              </div>
              <button class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction">
                <i class="fas fa-download mr-2"></i>Descargar
              </button>
            </div>
          </div>
          
          <div class="glass rounded-lg p-4 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold text-lg">Habilidades digitales y seguridad en línea</h4>
                <p class="text-sm opacity-70">Chaverra Pino Y., Munera Cavadias L. - 2024</p>
                <p class="text-sm mt-2">Diseño de un E-book como recurso educativo digital para promover el uso seguro de la tecnología.</p>
                <div class="flex items-center space-x-4 mt-3 text-sm">
                  <span class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-2 py-1 rounded">Proyecto</span>
                  <span><i class="fas fa-download mr-1"></i> 89 descargas</span>
                </div>
              </div>
              <button class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction">
                <i class="fas fa-download mr-2"></i>Descargar
              </button>
            </div>
          </div>
        </div>
        
        <!-- Upload Button -->
        <div class="mt-6 text-center">
          <button onclick="showNotification('Función disponible para docentes autorizados', 'info')" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold micro-interaction">
            <i class="fas fa-upload mr-2"></i>Subir Trabajo al Repositorio
          </button>
        </div>
      </div>
    </div>
    
    <!-- Resources Tab -->
    <div id="resources-tab" class="tab-content hidden">
      <div class="glass rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4 tracking-tight">Bases de Datos y Recursos Electrónicos</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Accede a bases de datos académicas, recursos educativos y material de apoyo.</p>
        
        <!-- Resource Categories -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="glass rounded-lg p-6 hover:bg-gray-100 dark:hover:bg-gray-700 transition cursor-pointer">
            <i class="fas fa-globe text-4xl text-blue-600 mb-4"></i>
            <h3 class="font-semibold text-lg mb-2">Recursos Gratuitos</h3>
            <p class="text-sm opacity-70 mb-4">Acceso libre a bibliotecas digitales y recursos educativos abiertos.</p>
            <ul class="space-y-2 text-sm">
              <li><a href="#" class="text-purple-600 hover:underline">• Google Scholar</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• Khan Academy</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• Project Gutenberg</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• OpenLibrary</a></li>
            </ul>
          </div>
          
          <div class="glass rounded-lg p-6 hover:bg-gray-100 dark:hover:bg-gray-700 transition cursor-pointer">
            <i class="fas fa-university text-4xl text-green-600 mb-4"></i>
            <h3 class="font-semibold text-lg mb-2">Bases de Datos Académicas</h3>
            <p class="text-sm opacity-70 mb-4">Acceso a publicaciones científicas y académicas.</p>
            <ul class="space-y-2 text-sm">
              <li><a href="#" class="text-purple-600 hover:underline">• EBSCO Discovery</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• SciELO Colombia</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• Dialnet</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• DOAJ</a></li>
            </ul>
          </div>
          
          <div class="glass rounded-lg p-6 hover:bg-gray-100 dark:hover:bg-gray-700 transition cursor-pointer">
            <i class="fas fa-book-open text-4xl text-purple-600 mb-4"></i>
            <h3 class="font-semibold text-lg mb-2">Bibliotecas Digitales</h3>
            <p class="text-sm opacity-70 mb-4">Colecciones digitales de libros y documentos.</p>
            <ul class="space-y-2 text-sm">
              <li><a href="#" class="text-purple-600 hover:underline">• Biblioteca Digital Colombia</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• Biblioteca Virtual Miguel de Cervantes</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• Europeana</a></li>
              <li><a href="#" class="text-purple-600 hover:underline">• World Digital Library</a></li>
            </ul>
          </div>
        </div>
        
        <!-- Resource Search Guide -->
        <div class="mt-8 bg-blue-50 dark:bg-blue-900 rounded-lg p-6">
          <h3 class="font-semibold text-lg mb-3">¿Cómo buscar información académica?</h3>
          <ol class="space-y-2 text-sm">
            <li>1. Define claramente tu tema de investigación</li>
            <li>2. Identifica palabras clave relevantes</li>
            <li>3. Utiliza operadores booleanos (AND, OR, NOT)</li>
            <li>4. Filtra por fecha, tipo de documento y área temática</li>
            <li>5. Evalúa la credibilidad de las fuentes</li>
          </ol>
          <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction">
            <i class="fas fa-info-circle mr-2"></i>Ver Tutorial Completo
          </button>
        </div>
      </div>
    </div>
    
    <!-- Multimedia Tab -->
    <div id="multimedia-tab" class="tab-content hidden">
      <div class="glass rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4 tracking-tight">Recursos Multimedia Educativos</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Videos, podcasts y material audiovisual para apoyar tu aprendizaje.</p>
        
        <!-- Multimedia Categories -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Video Educativo -->
          <div class="glass rounded-lg overflow-hidden">
            <div class="bg-gradient-to-br from-red-500 to-pink-600 h-48 flex items-center justify-center">
              <i class="fas fa-play-circle text-white text-6xl opacity-80"></i>
            </div>
            <div class="p-4">
              <h3 class="font-semibold mb-2">Experimentos de Química</h3>
              <p class="text-sm opacity-70 mb-3">Serie de videos sobre experimentos seguros para realizar en casa.</p>
              <div class="flex justify-between items-center">
                <span class="text-xs opacity-60">15 videos</span>
                <button class="bg-red-600 text-white px-3 py-1 rounded text-sm font-semibold micro-interaction">
                  Ver Serie
                </button>
              </div>
            </div>
          </div>
          
          <!-- Podcast -->
          <div class="glass rounded-lg overflow-hidden">
            <div class="bg-gradient-to-br from-green-500 to-teal-600 h-48 flex items-center justify-center">
              <i class="fas fa-podcast text-white text-6xl opacity-80"></i>
            </div>
            <div class="p-4">
              <h3 class="font-semibold mb-2">Historia de Colombia</h3>
              <p class="text-sm opacity-70 mb-3">Podcast semanal sobre momentos clave de nuestra historia.</p>
              <div class="flex justify-between items-center">
                <span class="text-xs opacity-60">24 episodios</span>
                <button class="bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold micro-interaction">
                  Escuchar
                </button>
              </div>
            </div>
          </div>
          
          <!-- Documental -->
          <div class="glass rounded-lg overflow-hidden">
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 h-48 flex items-center justify-center">
              <i class="fas fa-film text-white text-6xl opacity-80"></i>
            </div>
            <div class="p-4">
              <h3 class="font-semibold mb-2">Naturaleza y Ciencia</h3>
              <p class="text-sm opacity-70 mb-3">Documentales sobre biodiversidad y ecosistemas colombianos.</p>
              <div class="flex justify-between items-center">
                <span class="text-xs opacity-60">8 documentales</span>
                <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-semibold micro-interaction">
                  Ver Ahora
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Featured Content -->
        <div class="mt-8">
          <h3 class="text-xl font-bold mb-4">Contenido Destacado</h3>
          <div class="glass rounded-lg p-6">
            <div class="flex items-center space-x-4">
              <i class="fas fa-star text-yellow-500 text-3xl"></i>
              <div class="flex-1">
                <h4 class="font-semibold">Serie: Matemáticas Visuales</h4>
                <p class="text-sm opacity-70">Aprende conceptos matemáticos complejos a través de animaciones interactivas.</p>
              </div>
              <button class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold micro-interaction">
                Explorar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Training Tab -->
    <div id="training-tab" class="tab-content hidden">
      <div class="glass rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4 tracking-tight">Formación de Usuarios</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Aprende a utilizar todos los recursos de la biblioteca de manera efectiva.</p>
        
        <!-- Training Modules -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Module 1 -->
          <div class="glass rounded-lg p-6">
            <div class="flex items-start space-x-4">
              <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-lg">
                <i class="fas fa-user-graduate text-purple-600 dark:text-purple-400 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-lg mb-2">Introducción a la Biblioteca Digital</h3>
                <p class="text-sm opacity-70 mb-4">Conoce todos los servicios y recursos disponibles en Lectorium.</p>
                <div class="space-y-2 text-sm">
                  <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span>Navegación básica</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span>Búsqueda de libros</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span>Gestión de préstamos</span>
                  </div>
                </div>
                <button class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction w-full">
                  Comenzar Curso
                </button>
              </div>
            </div>
          </div>
          
          <!-- Module 2 -->
          <div class="glass rounded-lg p-6">
            <div class="flex items-start space-x-4">
              <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
                <i class="fas fa-search text-blue-600 dark:text-blue-400 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-lg mb-2">Búsqueda Avanzada de Información</h3>
                <p class="text-sm opacity-70 mb-4">Técnicas para encontrar información académica de calidad.</p>
                <div class="space-y-2 text-sm">
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Operadores de búsqueda</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Evaluación de fuentes</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Citas y referencias</span>
                  </div>
                </div>
                <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction w-full">
                  Comenzar Curso
                </button>
              </div>
            </div>
          </div>
          
          <!-- Module 3 -->
          <div class="glass rounded-lg p-6">
            <div class="flex items-start space-x-4">
              <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg">
                <i class="fas fa-database text-green-600 dark:text-green-400 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-lg mb-2">Uso de Bases de Datos</h3>
                <p class="text-sm opacity-70 mb-4">Aprende a navegar y buscar en bases de datos académicas.</p>
                <div class="space-y-2 text-sm">
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>EBSCO Discovery</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Google Scholar</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Repositorios abiertos</span>
                  </div>
                </div>
                <button class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction w-full">
                  Comenzar Curso
                </button>
              </div>
            </div>
          </div>
          
          <!-- Module 4 -->
          <div class="glass rounded-lg p-6">
            <div class="flex items-start space-x-4">
              <div class="bg-orange-100 dark:bg-orange-900 p-3 rounded-lg">
                <i class="fas fa-edit text-orange-600 dark:text-orange-400 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-lg mb-2">Elaboración de Bibliografías</h3>
                <p class="text-sm opacity-70 mb-4">Crea referencias bibliográficas correctamente formateadas.</p>
                <div class="space-y-2 text-sm">
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Normas APA</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Gestores bibliográficos</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>
                    <span>Evitar el plagio</span>
                  </div>
                </div>
                <button class="mt-4 bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction w-full">
                  Comenzar Curso
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Upcoming Workshops -->
        <div class="mt-8">
          <h3 class="text-xl font-bold mb-4">Talleres Próximos</h3>
          <div class="space-y-3">
            <div class="glass rounded-lg p-4 flex justify-between items-center">
              <div>
                <h4 class="font-semibold">Investigación en la Era Digital</h4>
                <p class="text-sm opacity-70">Martes 20 de Marzo - 3:00 PM</p>
              </div>
              <button class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction">
                Inscribirse
              </button>
            </div>
            <div class="glass rounded-lg p-4 flex justify-between items-center">
              <div>
                <h4 class="font-semibold">Creación de Presentaciones Efectivas</h4>
                <p class="text-sm opacity-70">Jueves 22 de Marzo - 4:00 PM</p>
              </div>
              <button class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction">
                Inscribirse
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Chat Support Widget -->
  <div id="chatWidget" class="fixed bottom-4 right-4 z-50">
    <button id="chatToggle" class="bg-purple-600 text-white p-4 rounded-full shadow-lg micro-interaction">
      <i class="fas fa-comments text-xl"></i>
    </button>
    
    <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 h-96 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
      <div class="bg-purple-600 text-white p-4 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h3 class="font-semibold">Asistente Bibliotecario</h3>
          <button id="chatClose" class="text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="p-4 h-64 overflow-y-auto" id="chatMessages">
        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 mb-3">
          <p class="text-sm">¡Hola! Soy tu asistente bibliotecario. ¿En qué puedo ayudarte hoy?</p>
        </div>
      </div>
      
      <div class="p-4 border-t">
        <div class="flex space-x-2">
          <input 
            type="text" 
            id="chatInput" 
            class="flex-1 px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm"
            placeholder="Escribe tu pregunta..."
          >
          <button id="chatSend" class="bg-purple-600 text-white px-4 py-2 rounded-lg micro-interaction">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notifications Container -->
  <div id="toastContainer"></div>
  
  <!-- Login Modal -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="glass rounded-2xl p-8 w-full max-w-md mx-4 animate-fade-in">
      <div class="text-center mb-6">
        <div class="bg-gradient-to-br from-purple-600 to-purple-700 w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center">
          <i class="fas fa-book-open text-white text-3xl"></i>
        </div>
        <h2 id="authTitle" class="text-2xl font-bold tracking-tight">Iniciar Sesión</h2>
        <p id="authSubtitle" class="opacity-80 mt-2 leading-relaxed">Accede a la biblioteca digital</p>
        <div class="mt-3 bg-purple-50 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-4 py-2 rounded-lg text-sm font-medium">
          <i class="fas fa-info-circle"></i>
          Exclusivo para estudiantes y docentes de I.E. Luis Carlos López
        </div>
      </div>
      
      <div id="authError" class="bg-red-50 dark:bg-red-900 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg mb-4 hidden"></div>
      
      <form id="authForm">
        <div class="space-y-4">
          <div id="nameField" class="hidden">
            <label class="block text-sm font-medium mb-1 uppercase tracking-wider">Nombre completo</label>
            <div class="relative">
              <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
              <input 
                id="fullName" 
                type="text" 
                class="w-full pl-10 pr-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium"
                placeholder="Juan Pérez"
              >
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1 uppercase tracking-wider" for="email">Correo electrónico</label>
            <div class="relative">
              <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
              <input 
                id="email" 
                type="email" 
                class="w-full pl-10 pr-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium"
                placeholder="tu.nombre@ieluiscarloslopez.edu.co"
                required
              >
            </div>
            <p class="text-xs opacity-70 mt-1 font-medium">Solo correos institucionales @ieluiscarloslopez.edu.co</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1 uppercase tracking-wider">Contraseña</label>
            <div class="relative">
              <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
              <input 
                id="password" 
                type="password" 
                class="w-full pl-10 pr-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium"
                placeholder="••••••••"
                required
              >
              <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 opacity-50 hover:opacity-100">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          
          <div id="confirmPasswordField" class="hidden">
            <label class="block text-sm font-medium mb-1 uppercase tracking-wider">Confirmar contraseña</label>
            <div class="relative">
              <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
              <input 
                id="confirmPassword" 
                type="password" 
                class="w-full pl-10 pr-4 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium"
                placeholder="••••••••"
              >
            </div>
          </div>
        </div>
        
        <div class="mt-6 space-y-3">
          <button type="submit" id="authSubmitBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold micro-interaction uppercase tracking-wide">
            Iniciar Sesión
          </button>
          
          <button type="button" id="authToggleBtn" class="w-full text-purple-600 hover:text-purple-700 font-medium">
            ¿No tienes cuenta? Regístrate
          </button>
          
          <button type="button" id="authCancelBtn" class="w-full text-gray-500 hover:text-gray-700 font-medium">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Book Details Modal -->
  <div id="bookModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="glass rounded-2xl p-8 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto animate-fade-in">
      <div id="bookModalContent">
        <!-- Book details will be loaded here -->
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      createUserWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      addDoc, 
      query, 
      where, 
      orderBy, 
      serverTimestamp,
      doc,
      updateDoc,
      getDoc,
      limit,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAQZwAqOUHYoz1zICz7PXJt01q0FEJa15o",
      authDomain: "lectorium-a312d.firebaseapp.com",
      projectId: "lectorium-a312d",
      storageBucket: "lectorium-a312d.firebasestorage.app",
      messagingSenderId: "177236654132",
      appId: "1:177236654132:web:e00ecfcced130e89f0b261"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentUser = null;
    let books = [];
    let userLoans = [];
    let isLoginMode = true;

    // DOM Elements
    const elements = {
      // Theme
      themeToggle: document.getElementById('themeToggle'),
      themeIcon: document.getElementById('themeIcon'),
      
      // Header
      notificationBtn: document.getElementById('notificationBtn'),
      notificationCount: document.getElementById('notificationCount'),
      loginBtn: document.getElementById('loginBtn'),
      userMenu: document.getElementById('userMenu'),
      userMenuBtn: document.getElementById('userMenuBtn'),
      userDropdown: document.getElementById('userDropdown'),
      userEmail: document.getElementById('userEmail'),
      dropdownName: document.getElementById('dropdownName'),
      dropdownEmail: document.getElementById('dropdownEmail'),
      profileBtn: document.getElementById('profileBtn'),
      historyBtn: document.getElementById('historyBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      
      // Tabs
      tabBtns: document.querySelectorAll('.tab-btn'),
      tabContents: document.querySelectorAll('.tab-content'),
      
      // Dashboard
      totalBooksCount: document.getElementById('totalBooksCount'),
      availableBooksCount: document.getElementById('availableBooksCount'),
      myLoansCount: document.getElementById('myLoansCount'),
      dueSoonCount: document.getElementById('dueSoonCount'),
      recentBooks: document.getElementById('recentBooks'),
      
      // Catalog
      searchInput: document.getElementById('searchInput'),
      categoryFilter: document.getElementById('categoryFilter'),
      searchBtn: document.getElementById('searchBtn'),
      activeFilters: document.getElementById('activeFilters'),
      loadingBooks: document.getElementById('loadingBooks'),
      booksGrid: document.getElementById('booksGrid'),
      noResults: document.getElementById('noResults'),
      
      // Loans
      loansContainer: document.getElementById('loansContainer'),
      
      // Analytics
      topBooks: document.getElementById('topBooks'),
      
      // Auth Modal
      authModal: document.getElementById('authModal'),
      authForm: document.getElementById('authForm'),
      authTitle: document.getElementById('authTitle'),
      authSubtitle: document.getElementById('authSubtitle'),
      authError: document.getElementById('authError'),
      authSubmitBtn: document.getElementById('authSubmitBtn'),
      authToggleBtn: document.getElementById('authToggleBtn'),
      authCancelBtn: document.getElementById('authCancelBtn'),
      nameField: document.getElementById('nameField'),
      fullName: document.getElementById('fullName'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      togglePassword: document.getElementById('togglePassword'),
      confirmPasswordField: document.getElementById('confirmPasswordField'),
      confirmPassword: document.getElementById('confirmPassword'),
      
      // Book Modal
      bookModal: document.getElementById('bookModal'),
      bookModalContent: document.getElementById('bookModalContent'),
      
      // Toast
      toastContainer: document.getElementById('toastContainer')
    };

    // Theme Toggle
    elements.themeToggle.addEventListener('click', () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      html.setAttribute('data-theme', newTheme);
      elements.themeIcon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun text-yellow-300';
      
      localStorage.setItem('theme', newTheme);
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    elements.themeIcon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun text-yellow-300';

    // Tab Navigation
    elements.tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        
        elements.tabBtns.forEach(b => b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        
        elements.tabContents.forEach(content => {
          content.classList.add('hidden');
          if (content.id === `${tabName}-tab`) {
            content.classList.remove('hidden');
            
            if (tabName === 'analytics' && currentUser) {
              setTimeout(initCharts, 100);
            }
          }
        });
      });
    });

    // Toast Notifications
    window.showNotification = function(message, type = 'info') {
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
      };
      
      const colors = {
        success: 'text-green-600',
        error: 'text-red-600',
        info: 'text-blue-600',
        warning: 'text-yellow-600'
      };
      
      const toast = document.createElement('div');
      toast.className = 'toast bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200';
      toast.innerHTML = `
        <div class="flex items-center space-x-3">
          <i class="fas ${icons[type]} ${colors[type]} text-xl"></i>
          <span class="font-medium">${message}</span>
        </div>
      `;
      
      elements.toastContainer.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    };

    // Initial books data
    const initialBooks = [
      { 
        titulo: "Cien Años de Soledad", 
        autor: "Gabriel García Márquez", 
        categoria: "moderno", 
        disponible: true,
        isbn: "978-0-06-088328-7",
        año: 1967,
        editorial: "Harper & Row",
        paginas: 417,
        descripcion: "La historia épica de la familia Buendía a lo largo de siete generaciones en el pueblo ficticio de Macondo.",
        vecesPrestado: 0
      },
      { 
        titulo: "Don Quijote de la Mancha", 
        autor: "Miguel de Cervantes", 
        categoria: "clasico", 
        disponible: true,
        isbn: "978-84-376-0494-7",
        año: 1605,
        editorial: "Francisco de Robles",
        paginas: 1023,
        descripcion: "Las aventuras del hidalgo Don Quijote y su fiel escudero Sancho Panza.",
        vecesPrestado: 0
      },
      { 
        titulo: "1984", 
        autor: "George Orwell", 
        categoria: "ficcion", 
        disponible: true,
        isbn: "978-0-452-28423-4",
        año: 1949,
        editorial: "Secker & Warburg",
        paginas: 328,
        descripcion: "Una distopía en la que un superestado totalitario controla cada aspecto de la vida.",
        vecesPrestado: 0
      },
      { 
        titulo: "El Principito", 
        autor: "Antoine de Saint-Exupéry", 
        categoria: "infantil", 
        disponible: true,
        isbn: "978-0-15-601219-5",
        año: 1943,
        editorial: "Reynal & Hitchcock",
        paginas: 96,
        descripcion: "Un piloto se encuentra en el desierto del Sahara con un pequeño príncipe de otro planeta.",
        vecesPrestado: 0
      },
      { 
        titulo: "Harry Potter y la Piedra Filosofal", 
        autor: "J.K. Rowling", 
        categoria: "juvenil", 
        disponible: true,
        isbn: "978-0-439-70818-8",
        año: 1997,
        editorial: "Bloomsbury",
        paginas: 223,
        descripcion: "Las aventuras de un joven mago en su primer año en Hogwarts.",
        vecesPrestado: 0
      },
      { 
        titulo: "Sapiens", 
        autor: "Yuval Noah Harari", 
        categoria: "ciencia", 
        disponible: true,
        isbn: "978-0-06-231609-7",
        año: 2011,
        editorial: "Harper",
        paginas: 443,
        descripcion: "Una breve historia de la humanidad desde la Edad de Piedra hasta el siglo XXI.",
        vecesPrestado: 0
      },
      { 
        titulo: "El Diario de Ana Frank", 
        autor: "Ana Frank", 
        categoria: "historia", 
        disponible: true,
        isbn: "978-0-553-29698-3",
        año: 1947,
        editorial: "Contact Publishing",
        paginas: 283,
        descripcion: "El diario íntimo de una niña judía durante la Segunda Guerra Mundial.",
        vecesPrestado: 0
      }
    ];

    // Initialize books collection
    async function initializeBooks() {
      try {
        const booksRef = collection(db, "libros");
        const snapshot = await getDocs(booksRef);
        
        if (snapshot.empty) {
          console.log('Initializing books collection...');
          for (const book of initialBooks) {
            await addDoc(booksRef, {
              ...book,
              fechaAgregado: serverTimestamp()
            });
          }
          showNotification('Biblioteca inicializada con éxito', 'success');
        }
      } catch (error) {
        console.error('Error initializing books:', error);
        showNotification('Error al inicializar la biblioteca', 'error');
      }
    }

    // Load books
    async function loadBooks() {
      try {
        elements.loadingBooks.classList.remove('hidden');
        elements.booksGrid.classList.add('hidden');
        
        await initializeBooks();
        
        const snapshot = await getDocs(collection(db, "libros"));
        books = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        updateDashboardStats();
        displayBooks(books);
        displayRecentBooks();
        
        elements.loadingBooks.classList.add('hidden');
        elements.booksGrid.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading books:', error);
        showNotification('Error al cargar los libros', 'error');
        elements.loadingBooks.classList.add('hidden');
      }
    }

    // Update dashboard statistics
    function updateDashboardStats() {
      const totalBooks = books.length;
      const availableBooks = books.filter(book => book.disponible).length;
      const myLoans = userLoans.filter(loan => loan.estado === 'activo').length;
      const dueSoon = userLoans.filter(loan => {
        if (loan.estado !== 'activo') return false;
        const daysLeft = calculateDaysLeft(loan.fechaVencimiento);
        return daysLeft >= 0 && daysLeft <= 7;
      }).length;
      
      elements.totalBooksCount.textContent = totalBooks;
      elements.availableBooksCount.textContent = availableBooks;
      elements.myLoansCount.textContent = myLoans;
      elements.dueSoonCount.textContent = dueSoon;
      
      // Update notification count
      if (dueSoon > 0) {
        elements.notificationCount.textContent = dueSoon;
        elements.notificationCount.classList.remove('hidden');
      } else {
        elements.notificationCount.classList.add('hidden');
      }
    }

    // Display recent books
    function displayRecentBooks() {
      const recentBooks = books
        .sort((a, b) => (b.fechaAgregado?.seconds || 0) - (a.fechaAgregado?.seconds || 0))
        .slice(0, 5);
      
      elements.recentBooks.innerHTML = recentBooks.map(book => `
        <div class="flex items-center justify-between p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg cursor-pointer" onclick="showBookDetails('${book.id}')">
          <div>
            <p class="font-semibold">${book.titulo}</p>
            <p class="text-sm opacity-70">${book.autor}</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full ${book.disponible ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
            ${book.disponible ? 'Disponible' : 'Prestado'}
          </span>
        </div>
      `).join('');
    }

    // Display books
    function displayBooks(booksToShow) {
      elements.booksGrid.innerHTML = '';
      
      if (booksToShow.length === 0) {
        elements.noResults.classList.remove('hidden');
        return;
      }
      
      elements.noResults.classList.add('hidden');
      
      booksToShow.forEach(book => {
        const card = document.createElement('div');
        card.className = 'glass rounded-xl overflow-hidden book-card cursor-pointer';
        
        const categoryColors = {
          clasico: 'from-amber-500 to-orange-600',
          moderno: 'from-purple-500 to-pink-600',
          ficcion: 'from-blue-500 to-indigo-600',
          ciencia: 'from-green-500 to-teal-600',
          historia: 'from-red-500 to-pink-600',
          infantil: 'from-yellow-400 to-orange-500',
          juvenil: 'from-pink-500 to-purple-600'
        };
        
        const gradient = categoryColors[book.categoria] || 'from-gray-500 to-gray-600';
        
        card.innerHTML = `
          <div class="relative">
            <div class="bg-gradient-to-br ${gradient} h-48 flex items-center justify-center">
              <i class="fas fa-book text-white text-5xl opacity-80"></i>
            </div>
            <div class="absolute top-2 right-2 bg-${book.disponible ? 'green' : 'red'}-500 text-white px-2 py-1 rounded-full text-xs font-semibold">
              ${book.disponible ? 'Disponible' : 'Prestado'}
            </div>
          </div>
          <div class="p-4">
            <h3 class="font-semibold text-lg mb-1 line-clamp-1">${book.titulo}</h3>
            <p class="text-sm opacity-70 mb-2">${book.autor}</p>
            <p class="text-xs opacity-60 mb-3">ISBN: ${book.isbn || 'No disponible'}</p>
            <div class="flex space-x-2">
              <button onclick="event.stopPropagation(); ${book.disponible ? `requestBook('${book.id}')` : 'showNotification(\'Este libro no está disponible\', \'warning\')'}" 
                class="flex-1 bg-purple-600 text-white py-2 rounded-lg text-sm font-semibold micro-interaction ${!book.disponible ? 'opacity-50 cursor-not-allowed' : ''}">
                ${book.disponible ? 'Solicitar' : 'No disponible'}
              </button>
              <button onclick="event.stopPropagation(); showBookDetails('${book.id}')" class="p-2 glass rounded-lg micro-interaction">
                <i class="fas fa-info-circle"></i>
              </button>
            </div>
          </div>
        `;
        
        card.addEventListener('click', () => showBookDetails(book.id));
        elements.booksGrid.appendChild(card);
      });
    }

    // Show book details
    window.showBookDetails = function(bookId) {
      const book = books.find(b => b.id === bookId);
      if (!book) return;
      
      const categoryColors = {
        clasico: 'from-amber-500 to-orange-600',
        moderno: 'from-purple-500 to-pink-600',
        ficcion: 'from-blue-500 to-indigo-600',
        ciencia: 'from-green-500 to-teal-600',
        historia: 'from-red-500 to-pink-600',
        infantil: 'from-yellow-400 to-orange-500',
        juvenil: 'from-pink-500 to-purple-600'
      };
      
      const gradient = categoryColors[book.categoria] || 'from-gray-500 to-gray-600';
      
      elements.bookModalContent.innerHTML = `
        <div class="flex justify-between items-start mb-6">
          <h2 class="text-2xl font-bold tracking-tight">${book.titulo}</h2>
          <button onclick="closeBookModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <div class="bg-gradient-to-br ${gradient} h-64 rounded-lg mb-4 flex items-center justify-center">
              <i class="fas fa-book text-white text-6xl opacity-80"></i>
            </div>
            <div class="space-y-2 text-sm">
              <p><span class="font-medium">Autor:</span> ${book.autor}</p>
              <p><span class="font-medium">ISBN:</span> ${book.isbn || 'No disponible'}</p>
              <p><span class="font-medium">Año:</span> ${book.año || 'No disponible'}</p>
              <p><span class="font-medium">Editorial:</span> ${book.editorial || 'No disponible'}</p>
              <p><span class="font-medium">Páginas:</span> ${book.paginas || 'No disponible'}</p>
              <p><span class="font-medium">Categoría:</span> ${book.categoria}</p>
              <p><span class="font-medium">Veces prestado:</span> ${book.vecesPrestado || 0}</p>
            </div>
          </div>
          
          <div>
            <h3 class="font-semibold text-lg mb-3">Descripción</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6 leading-relaxed">
              ${book.descripcion || 'No hay descripción disponible para este libro.'}
            </p>
            
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-6">
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Estado del libro:</p>
              <p class="text-lg font-semibold ${book.disponible ? 'text-green-600' : 'text-red-600'}">
                ${book.disponible ? '✓ Disponible para préstamo' : '✗ Actualmente prestado'}
              </p>
            </div>
            
            ${currentUser ? `
              <button 
                onclick="${book.disponible ? `requestBook('${book.id}'); closeBookModal();` : 'showNotification(\'Este libro no está disponible\', \'warning\')'}" 
                class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold micro-interaction ${!book.disponible ? 'opacity-50 cursor-not-allowed' : ''}"
              >
                ${book.disponible ? 'Solicitar Préstamo' : 'No Disponible'}
              </button>
            ` : `
              <button 
                onclick="closeBookModal(); elements.authModal.classList.remove('hidden');" 
                class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold micro-interaction"
              >
                Iniciar sesión para solicitar préstamo
              </button>
            `}
          </div>
        </div>
      `;
      
      elements.bookModal.classList.remove('hidden');
    };

    window.closeBookModal = function() {
      elements.bookModal.classList.add('hidden');
    };

    // Request book
    window.requestBook = async function(bookId) {
      if (!currentUser) {
        showNotification('Debes iniciar sesión para solicitar libros', 'warning');
        elements.authModal.classList.remove('hidden');
        return;
      }
      
      try {
        const book = books.find(b => b.id === bookId);
        if (!book || !book.disponible) {
          showNotification('Este libro no está disponible', 'error');
          return;
        }
        
        // Check if user already has this book
        const loansRef = collection(db, "prestamos");
        const q = query(loansRef, 
          where("userId", "==", currentUser.uid),
          where("libroId", "==", bookId),
          where("estado", "==", "activo")
        );
        const existingLoans = await getDocs(q);
        
        if (!existingLoans.empty) {
          showNotification('Ya tienes este libro en préstamo', 'warning');
          return;
        }
        
        // Check loan limit (max 3 books)
        const activeLoansQuery = query(loansRef,
          where("userId", "==", currentUser.uid),
          where("estado", "==", "activo")
        );
        const activeLoans = await getDocs(activeLoansQuery);
        
        if (activeLoans.size >= 3) {
          showNotification('Has alcanzado el límite de 3 préstamos activos', 'warning');
          return;
        }
        
        // Create loan
        const loanData = {
          userId: currentUser.uid,
          userEmail: currentUser.email,
          userName: currentUser.displayName || 'Usuario',
          libroId: bookId,
          titulo: book.titulo,
          autor: book.autor,
          isbn: book.isbn || 'No disponible',
          fechaPrestamo: serverTimestamp(),
          fechaVencimiento: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000), // 14 days
          estado: "activo",
          renovaciones: 0
        };
        
        await addDoc(collection(db, "prestamos"), loanData);
        
        // Update book availability
        await updateDoc(doc(db, "libros", bookId), { 
          disponible: false,
          vecesPrestado: (book.vecesPrestado || 0) + 1
        });
        
        showNotification(`¡Préstamo exitoso! Tienes 14 días para devolver "${book.titulo}"`, 'success');
        
        await loadBooks();
        await loadLoans();
      } catch (error) {
        console.error('Error requesting book:', error);
        showNotification('Error al procesar el préstamo', 'error');
      }
    };

    // Load user loans
    async function loadLoans() {
      if (!currentUser) {
        elements.loansContainer.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-lock text-6xl opacity-20 mb-4"></i>
            <p class="text-xl font-semibold opacity-70">Inicia sesión para ver tus préstamos</p>
          </div>
        `;
        return;
      }
      
      try {
        const q = query(
          collection(db, "prestamos"),
          where("userId", "==", currentUser.uid),
          where("estado", "==", "activo"),
          orderBy("fechaPrestamo", "desc")
        );
        
        const snapshot = await getDocs(q);
        userLoans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        displayLoans();
        updateDashboardStats();
      } catch (error) {
        console.error('Error loading loans:', error);
        showNotification('Error al cargar los préstamos', 'error');
      }
    }

    // Display loans
    function displayLoans() {
      if (userLoans.length === 0) {
        elements.loansContainer.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-book-open text-6xl opacity-20 mb-4"></i>
            <p class="text-xl font-semibold opacity-70">No tienes préstamos activos</p>
            <p class="text-sm opacity-50 mt-2">¡Explora nuestro catálogo y encuentra tu próxima lectura!</p>
          </div>
        `;
        return;
      }
      
      elements.loansContainer.innerHTML = userLoans.map(loan => {
        const daysLeft = calculateDaysLeft(loan.fechaVencimiento);
        const isOverdue = daysLeft < 0;
        const isNearDue = daysLeft >= 0 && daysLeft <= 3;
        
        return `
          <div class="glass rounded-lg p-4 ${isOverdue ? 'border-2 border-red-500' : isNearDue ? 'border-2 border-yellow-500' : ''}">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold text-lg">${loan.titulo}</h4>
                <p class="text-sm opacity-70">${loan.autor}</p>
                <div class="mt-2 space-y-1 text-sm">
                  <p><i class="fas fa-calendar-check mr-2"></i>Prestado: ${formatDate(loan.fechaPrestamo)}</p>
                  <p><i class="fas fa-calendar-times mr-2"></i>Vence: ${formatDate(loan.fechaVencimiento)}</p>
                  ${loan.renovaciones > 0 ? `<p><i class="fas fa-sync mr-2"></i>Renovaciones: ${loan.renovaciones}/2</p>` : ''}
                </div>
                <div class="mt-3">
                  ${isOverdue ? 
                    `<span class="text-red-600 font-semibold"><i class="fas fa-exclamation-triangle mr-1"></i>Vencido hace ${Math.abs(daysLeft)} días</span>` : 
                    isNearDue ?
                    `<span class="text-yellow-600 font-semibold"><i class="fas fa-clock mr-1"></i>Vence en ${daysLeft} días</span>` :
                    `<span class="text-green-600 font-semibold"><i class="fas fa-check-circle mr-1"></i>${daysLeft} días restantes</span>`
                  }
                </div>
              </div>
              
              <div class="flex flex-col space-y-2">
                <button onclick="returnBook('${loan.id}', '${loan.libroId}')" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction">
                  <i class="fas fa-undo mr-2"></i>Devolver
                </button>
                ${!isOverdue && loan.renovaciones < 2 ? `
                  <button onclick="renewLoan('${loan.id}')" 
                    class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold micro-interaction">
                    <i class="fas fa-sync mr-2"></i>Renovar
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Calculate days left
    function calculateDaysLeft(vencimiento) {
      if (!vencimiento) return 0;
      
      let due;
      if (vencimiento.toDate) {
        due = vencimiento.toDate();
      } else if (vencimiento.seconds) {
        due = new Date(vencimiento.seconds * 1000);
      } else if (vencimiento instanceof Date) {
        due = vencimiento;
      } else {
        due = new Date(vencimiento);
      }
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      due.setHours(0, 0, 0, 0);
      
      const diffTime = due - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }

    // Format date
    function formatDate(timestamp) {
      if (!timestamp) return 'Fecha no disponible';
      
      let date;
      if (timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp.seconds) {
        date = new Date(timestamp.seconds * 1000);
      } else if (timestamp instanceof Date) {
        date = timestamp;
      } else {
        date = new Date(timestamp);
      }
      
      return date.toLocaleDateString('es-ES', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
    }

    // Return book
    window.returnBook = async function(loanId, bookId) {
      if (confirm('¿Estás seguro de que deseas devolver este libro?')) {
        try {
          await updateDoc(doc(db, "prestamos", loanId), {
            estado: "devuelto",
            fechaDevolucion: serverTimestamp()
          });
          
          await updateDoc(doc(db, "libros", bookId), { disponible: true });
          
          showNotification('Libro devuelto exitosamente', 'success');
          
          await loadBooks();
          await loadLoans();
        } catch (error) {
          console.error('Error returning book:', error);
          showNotification('Error al devolver el libro', 'error');
        }
      }
    };

    // Renew loan
    window.renewLoan = async function(loanId) {
      try {
        const loan = userLoans.find(l => l.id === loanId);
        if (!loan) return;
        
        if (loan.renovaciones >= 2) {
          showNotification('Has alcanzado el límite de renovaciones', 'warning');
          return;
        }
        
        const newDueDate = new Date();
        if (loan.fechaVencimiento.toDate) {
          newDueDate.setTime(loan.fechaVencimiento.toDate().getTime());
        } else if (loan.fechaVencimiento.seconds) {
          newDueDate.setTime(loan.fechaVencimiento.seconds * 1000);
        } else {
          newDueDate.setTime(new Date(loan.fechaVencimiento).getTime());
        }
        newDueDate.setDate(newDueDate.getDate() + 7); // Add 7 days
        
        await updateDoc(doc(db, "prestamos", loanId), {
          fechaVencimiento: newDueDate,
          renovaciones: loan.renovaciones + 1
        });
        
        showNotification('Préstamo renovado por 7 días adicionales', 'success');
        await loadLoans();
      } catch (error) {
        console.error('Error renewing loan:', error);
        showNotification('Error al renovar el préstamo', 'error');
      }
    };

    // Search and filter
    elements.searchBtn.addEventListener('click', filterBooks);
    elements.searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') filterBooks();
    });
    elements.categoryFilter.addEventListener('change', filterBooks);

    function filterBooks() {
      const searchTerm = elements.searchInput.value.toLowerCase().trim();
      const category = elements.categoryFilter.value;
      
      let filtered = books;
      
      if (searchTerm) {
        filtered = filtered.filter(book => 
          book.titulo.toLowerCase().includes(searchTerm) ||
          book.autor.toLowerCase().includes(searchTerm) ||
          (book.isbn && book.isbn.toLowerCase().includes(searchTerm))
        );
      }
      
      if (category) {
        filtered = filtered.filter(book => book.categoria === category);
      }
      
      displayBooks(filtered);
      updateActiveFilters(searchTerm, category);
    }

    function updateActiveFilters(search, category) {
      elements.activeFilters.innerHTML = '';
      const filters = [];
      
      if (search) {
        filters.push(`Búsqueda: "${search}"`);
      }
      
      if (category) {
        const categoryText = elements.categoryFilter.options[elements.categoryFilter.selectedIndex].text;
        filters.push(`Categoría: ${categoryText}`);
      }
      
      if (filters.length > 0) {
        elements.activeFilters.classList.remove('hidden');
        filters.forEach(filter => {
          const chip = document.createElement('span');
          chip.className = 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full text-sm font-medium';
          chip.innerHTML = `
            ${filter}
            <button onclick="clearFilters()" class="ml-2 hover:text-purple-900">
              <i class="fas fa-times"></i>
            </button>
          `;
          elements.activeFilters.appendChild(chip);
        });
      } else {
        elements.activeFilters.classList.add('hidden');
      }
    }

    window.clearFilters = function() {
      elements.searchInput.value = '';
      elements.categoryFilter.value = '';
      filterBooks();
    };

    // Initialize charts
    async function initCharts() {
      // Monthly chart
      const monthlyCtx = document.getElementById('monthlyChart');
      if (monthlyCtx && Chart.getChart(monthlyCtx)) {
        Chart.getChart(monthlyCtx).destroy();
      }
      
      if (monthlyCtx) {
        new Chart(monthlyCtx, {
          type: 'line',
          data: {
            labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
            datasets: [{
              label: 'Préstamos',
              data: [12, 19, 15, 25, 22, 30],
              borderColor: 'rgb(102, 126, 234)',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            }
          }
        });
      }
      
      // Category chart
      const categoryCtx = document.getElementById('categoryChart');
      if (categoryCtx && Chart.getChart(categoryCtx)) {
        Chart.getChart(categoryCtx).destroy();
      }
      
      if (categoryCtx) {
        const categoryCount = {};
        books.forEach(book => {
          categoryCount[book.categoria] = (categoryCount[book.categoria] || 0) + 1;
        });
        
        new Chart(categoryCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(categoryCount),
            datasets: [{
              data: Object.values(categoryCount),
              backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(72, 187, 120, 0.8)',
                'rgba(246, 173, 85, 0.8)',
                'rgba(237, 100, 166, 0.8)',
                'rgba(160, 174, 192, 0.8)',
                'rgba(252, 129, 129, 0.8)',
                'rgba(245, 158, 11, 0.8)'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }
      
      // Top books
      const topBooks = books
        .sort((a, b) => (b.vecesPrestado || 0) - (a.vecesPrestado || 0))
        .slice(0, 5);
      
      elements.topBooks.innerHTML = topBooks.map((book, index) => `
        <div class="flex items-center justify-between p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
          <div class="flex items-center space-x-3">
            <span class="text-2xl font-bold text-purple-600">#${index + 1}</span>
            <div>
              <p class="font-semibold">${book.titulo}</p>
              <p class="text-sm opacity-70">${book.autor}</p>
            </div>
          </div>
          <span class="text-sm font-medium">${book.vecesPrestado || 0} préstamos</span>
        </div>
      `).join('');
    }

    // Auth functions
    const ALLOWED_DOMAIN = '@ieluiscarloslopez.edu.co';
    
    function isValidInstitutionalEmail(email) {
      return email.toLowerCase().endsWith(ALLOWED_DOMAIN.toLowerCase());
    }

    // Auth form submission
    elements.authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = elements.email.value.trim();
      const password = elements.password.value;
      
      if (!email || !password) {
        showAuthError('Por favor completa todos los campos');
        return;
      }
      
      if (!isValidInstitutionalEmail(email)) {
        showAuthError(`Solo se permiten correos institucionales ${ALLOWED_DOMAIN}`);
        return;
      }
      
      try {
        if (isLoginMode) {
          await signInWithEmailAndPassword(auth, email, password);
          showNotification('¡Bienvenido de nuevo!', 'success');
        } else {
          const fullName = elements.fullName.value.trim();
          const confirmPassword = elements.confirmPassword.value;
          
          if (!fullName) {
            showAuthError('Por favor ingresa tu nombre completo');
            return;
          }
          
          if (password !== confirmPassword) {
            showAuthError('Las contraseñas no coinciden');
            return;
          }
          
          if (password.length < 6) {
            showAuthError('La contraseña debe tener al menos 6 caracteres');
            return;
          }
          
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(userCredential.user, { displayName: fullName });
          
          showNotification('¡Cuenta creada exitosamente!', 'success');
        }
        
        elements.authModal.classList.add('hidden');
        clearAuthForm();
      } catch (error) {
        showAuthError(getAuthErrorMessage(error));
      }
    });

    function showAuthError(message) {
      elements.authError.textContent = message;
      elements.authError.classList.remove('hidden');
      setTimeout(() => elements.authError.classList.add('hidden'), 5000);
    }

    function clearAuthForm() {
      elements.authForm.reset();
      elements.authError.classList.add('hidden');
    }

    function getAuthErrorMessage(error) {
      const errorMessages = {
        'auth/user-not-found': `No existe una cuenta con este correo. Verifica que sea un correo ${ALLOWED_DOMAIN}`,
        'auth/wrong-password': 'Contraseña incorrecta',
        'auth/email-already-in-use': 'Este correo ya está registrado',
        'auth/weak-password': 'La contraseña debe tener al menos 6 caracteres',
        'auth/invalid-email': 'El correo electrónico no es válido',
        'auth/too-many-requests': 'Demasiados intentos. Intenta más tarde'
      };
      
      return errorMessages[error.code] || 'Error desconocido. Intenta nuevamente.';
    }

    // Toggle login/register
    elements.authToggleBtn.addEventListener('click', () => {
      isLoginMode = !isLoginMode;
      
      if (isLoginMode) {
        elements.authTitle.textContent = 'Iniciar Sesión';
        elements.authSubtitle.textContent = 'Accede a la biblioteca digital';
        elements.authSubmitBtn.textContent = 'Iniciar Sesión';
        elements.authToggleBtn.textContent = '¿No tienes cuenta? Regístrate';
        elements.nameField.classList.add('hidden');
        elements.confirmPasswordField.classList.add('hidden');
      } else {
        elements.authTitle.textContent = 'Crear Cuenta';
        elements.authSubtitle.textContent = 'Únete a la biblioteca digital';
        elements.authSubmitBtn.textContent = 'Registrarse';
        elements.authToggleBtn.textContent = '¿Ya tienes cuenta? Inicia sesión';
        elements.nameField.classList.remove('hidden');
        elements.confirmPasswordField.classList.remove('hidden');
      }
      
      clearAuthForm();
    });

    // Password visibility toggle
    elements.togglePassword.addEventListener('click', () => {
      const type = elements.password.type === 'password' ? 'text' : 'password';
      elements.password.type = type;
      elements.confirmPassword.type = type;
      elements.togglePassword.innerHTML = `<i class="fas fa-eye${type === 'password' ? '' : '-slash'}"></i>`;
    });

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      
      if (user) {
        elements.loginBtn.classList.add('hidden');
        elements.userMenu.classList.remove('hidden');
        
        const displayName = user.displayName || user.email.split('@')[0];
        elements.userEmail.textContent = displayName;
        elements.dropdownName.textContent = displayName;
        elements.dropdownEmail.textContent = user.email;
        
        await loadLoans();
      } else {
        elements.loginBtn.classList.remove('hidden');
        elements.userMenu.classList.add('hidden');
        userLoans = [];
      }
      
      updateDashboardStats();
    });

    // Event listeners
    elements.loginBtn.addEventListener('click', () => {
      elements.authModal.classList.remove('hidden');
    });

    elements.authCancelBtn.addEventListener('click', () => {
      elements.authModal.classList.add('hidden');
      clearAuthForm();
    });

    elements.logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      showNotification('Sesión cerrada exitosamente', 'info');
      window.location.reload();
    });

    elements.userMenuBtn.addEventListener('click', () => {
      elements.userDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!elements.userMenu.contains(e.target)) {
        elements.userDropdown.classList.add('hidden');
      }
    });

    // Close modals on outside click
    window.addEventListener('click', (e) => {
      if (e.target === elements.authModal) {
        elements.authModal.classList.add('hidden');
        clearAuthForm();
      }
      if (e.target === elements.bookModal) {
        elements.bookModal.classList.add('hidden');
      }
    });

    // Profile and history buttons
    elements.profileBtn.addEventListener('click', () => {
      showNotification('Perfil en construcción', 'info');
      elements.userDropdown.classList.add('hidden');
    });

    elements.historyBtn.addEventListener('click', () => {
      showNotification('Historial en construcción', 'info');
      elements.userDropdown.classList.add('hidden');
    });

    // Notification button
    elements.notificationBtn.addEventListener('click', () => {
      if (userLoans.length > 0) {
        document.querySelector('[data-tab="loans"]').click();
      } else {
        showNotification('No tienes notificaciones pendientes', 'info');
      }
    });

    // Initialize app
    async function init() {
      console.log('Inicializando Lectorium...');
      await loadBooks();
      
      if (currentUser) {
        await loadLoans();
      }
      
      console.log('Lectorium iniciado correctamente');
    }

    init();
  </script>
</body>
</html>
